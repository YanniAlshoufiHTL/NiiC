<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>NiiC â€“ Calendar</title>
    <script src="../out/fe-models/NiicAet.js"></script>
    <script src="../out/fe-models/NiicAppointment.js"></script>
    <script src="../out/fe-models/NiicEvent.js"></script>
    <script src="../out/fe-models/NiicTask.js"></script>
    <script src="../out/webcomps/header-bar.js" defer></script>
    <script src="../out/webcomps/side-bar.js" defer></script>
    <script src="../out/webcomps/calendar-minimap.js" defer></script>
    <script src="../out/webcomps/calendar-view.js" defer></script>
    <script src="../out/webcomps/titled-search-list.js" defer></script>

    <link rel="stylesheet" href="../styles/global.css">
    <link rel="stylesheet" href="../styles/calendar.css">

    <script>
        /** @type {NiicAppointment[]} */
        const appointments = [
            new NiicAppointment("Do something", 15, 20, ""), // , new Date("2024-02-08")
            new NiicAppointment("Do something else", 20, 21),
            new NiicAppointment("An appointment with a long name.", 2, 9),
        ];

        /** @type {NiicEvent[]} */
        const events = [
            new NiicEvent("An event with a very very long name.", 5, 14, "Do something"),
        ];

        /** @type {NiicTask[]} */
        const tasks = [
            new NiicTask("Hi", 3, 10, "Do something"),
            new NiicTask("Hi", 3, 10, "Do something", new Date(Date.parse("2024-03-08"))),
        ];
    </script>

</head>
<body>
<niic-sidebar></niic-sidebar>

<script>
    let date = new Date(Date.now());
</script>

<niic-header-bar>
    <div class="niic-header-list">
        <button class="niic-date-left-arrow" onclick="date.setDate(date.getDate() - 1); update();"><</button>
        <button class="niic-date-btn" onclick="date = new Date(Date.now()); update();"></button>
        <button class="niic-date-right-arrow" onclick="date.setDate(date.getDate() + 1); update();">></button>
    </div>

    <div class="niic-calendar-header-days">
        <p class="niic-calendar-header-days-0"></p>
        <p class="niic-calendar-header-days-1"></p>
        <p class="niic-calendar-header-days-2"></p>
        <p class="niic-calendar-header-days-3"></p>
        <p class="niic-calendar-header-days-4"></p>
        <p class="niic-calendar-header-days-5"></p>
        <p class="niic-calendar-header-days-6"></p>
    </div>

    <script>
        function update() {
            // Btn Header
            document.querySelector(".niic-date-btn").innerHTML = date.toDateString();

            // Header days
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            const dateTmp = new Date(date.toDateString());
            for (let i = 0; i < 7; i++) {
                const el = document.querySelector(`.niic-calendar-header-days-${i}`);
                el.innerHTML = `${days[dateTmp.getDay()]}<br>${dateTmp.getDate()}`;
                dateTmp.setDate(dateTmp.getDate() + 1);
            }

            // Calendar Minimap
            const calMinimap = document.querySelector(".niic-cal-minimap");
            calMinimap.dataset.firstDay = date.toDateString();
            calMinimap.dataset.month = date.getMonth().toString();
            if (calMinimap.setFirstDay) {
                calMinimap.setFirstDay(date.toDateString());
            }

            // Calendar Times
            const timesDiv = document.querySelector(".niic-calendar-day-times");

            for (let i = 1; i < 24; i++) {
                const p = document.createElement("p");
                p.style.position = "absolute";
                p.style.marginTop = `calc(${window.innerHeight - 130}px * ${i} / 23)`;
                p.textContent = `${i}`.padStart(2, '0');
                timesDiv.appendChild(p);
            }

            // AETs
            let tmpDate = new Date(date.toDateString());
            for (let i = 0; i < 7; i++) {
                /** @type {HTMLDivElement} */
                const zone = document.querySelector(`.niic-calendar-aet-zone-${i}`);
                // clear any existent AETs
                zone.innerHTML = ``;

                const aps = appointments.filter(x => x.date.toDateString() === tmpDate.toDateString())
                const evs = events.filter(x => x.date.toDateString() === tmpDate.toDateString())
                const tks = tasks.filter(x => x.date.toDateString() === tmpDate.toDateString())

                const aets = [...aps, ...evs, ...tks];

                aets.forEach(aet => {
                    const div = document.createElement("div");
                    div.style.marginTop = `calc(${window.innerHeight - 130}px * ${aet.startTime} / 23)`;
                    div.style.height = `calc(${aet.endTime - aet.startTime + 1} * 100% / 23)`
                    div.innerText = aet.title;
                    zone.appendChild(div);
                });

                tmpDate.setDate(tmpDate.getDate() + 1);

                // Change widths of headers
                for (let i = 0; i < 7; i++) {
                    const zone = document.querySelector(`.niic-calendar-aet-zone-${i}`);
                    const el = document.querySelector(`.niic-calendar-header-days-${i}`);
                    el.style.width = `${zone.clientWidth}px`;
                }
            }
        }

        setTimeout(() => {
            update();
        }, 0);

        window.addEventListener("resize", update);
    </script>

    <style>
        .niic-header-list {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10px;
            box-sizing: border-box;
            gap: 5px;
        }

        .niic-calendar-header-days {
            position: absolute;
            top: 70px;
            right: 0;
            display: flex;
            width: calc(100vw - 81px - 296px);

            > p {
                text-align: center;
                font-family: system-ui, sans-serif;
                font-size: 1.3rem;
                color: white;
            }
        }
    </style>
</niic-header-bar>

<section class="niic-calendar-main-section">

    <aside class="niic-calendar-aside">
        <div class="niic-calendar-aside-minimap">
            <niic-calendar-minimap class="niic-cal-minimap"></niic-calendar-minimap>
        </div>

        <div class="niic-calendar-aside-aet-lists">
            <niic-titled-search-list data-title="Tasks" class="niic-calendar-aside-list-tasks">
            </niic-titled-search-list>

            <niic-titled-search-list data-title="Events" class="niic-calendar-aside-list-events">
            </niic-titled-search-list>

            <niic-titled-search-list data-title="Appointments" class="niic-calendar-aside-list-appointments">
            </niic-titled-search-list>

        </div>
    </aside>

    <div class="niic-calendar-day-times"></div>

    <main class="niic-calendar-main">
        <script>
            const els = [];

            for (let i = 0; i < 7; i++) {
                els.push(`<div class="niic-calendar-aet-zone niic-calendar-aet-zone-${i}"></div>`);
            }

            document.querySelector(".niic-calendar-main").innerHTML = els.join("\n");
        </script>
    </main>
</section>


<script>
    const getItemsHtml = (arr) =>
        arr.map(x => `<li>${x.title}</li>`).join("\n");

    document.querySelector(".niic-calendar-aside-list-tasks").innerHTML = getItemsHtml(tasks);
    document.querySelector(".niic-calendar-aside-list-events").innerHTML = getItemsHtml(events);
    document.querySelector(".niic-calendar-aside-list-appointments").innerHTML = getItemsHtml(appointments);
</script>

</body>
</html>